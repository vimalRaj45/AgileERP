<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agile Board</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        :root {
            --todo-color: #dc3545;
            --inprogress-color: #fd7e14;
            --done-color: #198754;
            --high-priority: #dc3545;
            --medium-priority: #ffc107;
            --low-priority: #20c997;
        }
        
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .kanban-container {
            overflow-x: auto;
            padding-bottom: 20px;
        }
        
        .kanban-column {
            min-width: 320px;
            background: white;
            border-radius: 8px;
            border-top: 4px solid #6c757d;
            box-shadow: 0 2px 10px rgba(0,0,0,0.08);
        }
        
        .kanban-column.todo {
            border-top-color: var(--todo-color);
        }
        
        .kanban-column.in-progress {
            border-top-color: var(--inprogress-color);
        }
        
        .kanban-column.done {
            border-top-color: var(--done-color);
        }
        
        .kanban-header {
            border-bottom: 1px solid #dee2e6;
            padding: 15px;
            background-color: rgba(0,0,0,0.02);
            border-radius: 8px 8px 0 0;
        }
        
        .task-card {
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            margin-bottom: 12px;
            cursor: move;
            transition: all 0.2s ease;
            background: white;
        }
        
        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #adb5bd;
        }
        
        .task-card.high {
            border-left: 4px solid var(--high-priority);
        }
        
        .task-card.medium {
            border-left: 4px solid var(--medium-priority);
        }
        
        .task-card.low {
            border-left: 4px solid var(--low-priority);
        }
        
        .task-priority {
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: 12px;
            font-weight: 600;
        }
        
        .priority-high {
            background-color: rgba(220, 53, 69, 0.1);
            color: var(--high-priority);
        }
        
        .priority-medium {
            background-color: rgba(255, 193, 7, 0.1);
            color: #b68b00;
        }
        
        .priority-low {
            background-color: rgba(32, 201, 151, 0.1);
            color: var(--low-priority);
        }
        
        .assignee-avatar {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background-color: #6c757d;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
        }
        
        .comment-item {
            border-left: 3px solid #0d6efd;
            padding-left: 12px;
            margin-bottom: 12px;
        }
        
        .file-item {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 8px 12px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .activity-item {
            padding: 10px 15px;
            border-left: 3px solid #6c757d;
            margin-bottom: 10px;
            background-color: white;
            border-radius: 4px;
        }
        
        .dropdown-menu {
            min-width: 200px;
        }
        
        .user-badge {
            background-color: #e7f1ff;
            color: #0d6efd;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        
        .modal-header {
            background-color: #f8f9fa;
        }
        
        .kanban-column-body {
            min-height: 400px;
            max-height: 70vh;
            overflow-y: auto;
            padding: 15px;
        }
        
        .empty-state {
            text-align: center;
            color: #6c757d;
            padding: 40px 20px;
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #adb5bd;
        }
        
        @media (max-width: 768px) {
            .kanban-column {
                min-width: 280px;
            }
            
            .navbar-brand {
                font-size: 1.1rem;
            }
            
            .user-badge {
                display: none;
            }
        }
        
        .drag-over {
            background-color: rgba(13, 110, 253, 0.05);
            border: 2px dashed #0d6efd;
        }
    </style>
</head>
<body>
    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm mb-4">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold text-primary" href="#">
                <i class="bi bi-kanban-fill me-2"></i>Agile Board
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <div class="navbar-nav ms-auto align-items-center">
                    <div class="me-3">
                        <span class="user-badge" id="currentUser">
                            <i class="bi bi-person-circle me-1"></i>
                            <span>Loading...</span>
                        </span>
                    </div>
                    <a class="nav-link" href="/projects">
                        <i class="bi bi-grid-3x3-gap me-1"></i>Projects
                    </a>
                    <a class="nav-link" href="#" onclick="showActivity()">
                        <i class="bi bi-activity me-1"></i>Activity
                    </a>
                   <a class="nav-link" href="/leader">
            <i class="bi bi-award"></i> Leaderboard
          </a>
                      <a class="nav-link" href="/performance">
            <i class="bi bi-bar-chart-line"></i> Project Performance
          </a>
                    
                    <!-- Add to the navigation section in both files -->
<a href="/meetings" class="btn">Meeting Notes</a>
                    <button class="btn btn-outline-danger btn-sm ms-2" onclick="logout()">
                        <i class="bi bi-box-arrow-right me-1"></i>Logout
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container-fluid">
        <!-- Project Header -->
        <div class="row mb-4" id="projectInfo">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <h2 class="text-muted">Select a project from the Projects page</h2>
                        <p class="text-muted">Choose a project to start managing tasks</p>
                        <a href="/projects" class="btn btn-primary">
                            <i class="bi bi-arrow-right-circle me-1"></i>Go to Projects
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <!-- Kanban Board -->
        <div class="row d-none" id="kanbanContainer">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <div>
                        <h2 id="projectName" class="mb-0"></h2>
                        <p id="projectDescription" class="text-muted mb-0"></p>
                    </div>
                    <button class="btn btn-primary" onclick="showAddTaskModal()">
                        <i class="bi bi-plus-circle me-1"></i>Add Task
                    </button>
                </div>
                
                <div class="kanban-container">
                    <div class="d-flex gap-3">
                        <!-- To Do Column -->
                        <div class="kanban-column todo flex-shrink-0">
                            <div class="kanban-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0 fw-bold text-danger">To Do</h5>
                                    <span class="badge bg-danger" id="todoCount">0</span>
                                </div>
                                <p class="text-muted small mb-0">Tasks ready to start</p>
                            </div>
                            <div class="kanban-column-body" id="todoColumn" ondrop="drop(event)" ondragover="allowDrop(event)">
                                <div class="empty-state" id="todoEmpty">
                                    <i class="bi bi-inbox"></i>
                                    <p>No tasks here yet</p>
                                    <button class="btn btn-sm btn-outline-danger" onclick="showAddTaskModal()">
                                        Add first task
                                    </button>
                                </div>
                                <div id="todoTasks"></div>
                            </div>
                        </div>
                        
                        <!-- In Progress Column -->
                        <div class="kanban-column in-progress flex-shrink-0">
                            <div class="kanban-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0 fw-bold text-warning">In Progress</h5>
                                    <span class="badge bg-warning" id="inProgressCount">0</span>
                                </div>
                                <p class="text-muted small mb-0">Currently working on</p>
                            </div>
                            <div class="kanban-column-body" id="inProgressColumn" ondrop="drop(event)" ondragover="allowDrop(event)">
                                <div class="empty-state" id="inProgressEmpty">
                                    <i class="bi bi-arrow-right-circle"></i>
                                    <p>No tasks in progress</p>
                                </div>
                                <div id="inProgressTasks"></div>
                            </div>
                        </div>
                        
                        <!-- Done Column -->
                        <div class="kanban-column done flex-shrink-0">
                            <div class="kanban-header">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="mb-0 fw-bold text-success">Done</h5>
                                    <span class="badge bg-success" id="doneCount">0</span>
                                </div>
                                <p class="text-muted small mb-0">Completed tasks</p>
                            </div>
                            <div class="kanban-column-body" id="doneColumn" ondrop="drop(event)" ondragover="allowDrop(event)">
                                <div class="empty-state" id="doneEmpty">
                                    <i class="bi bi-check-circle"></i>
                                    <p>No completed tasks</p>
                                </div>
                                <div id="doneTasks"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Task Modal -->
    <div class="modal fade" id="taskModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Add Task</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Task Title *</label>
                        <input type="text" class="form-control" id="taskTitle" placeholder="Enter task title">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" id="taskDescription" rows="3" placeholder="Describe the task..."></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Priority</label>
                            <select class="form-select" id="taskPriority">
                                <option value="Low">Low</option>
                                <option value="Medium" selected>Medium</option>
                                <option value="High">High</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Assignee</label>
                            <select class="form-select" id="taskAssignee">
                                <option value="">Unassigned</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveTask()">Save Task</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Task Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailsTitle"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h6>Description</h6>
                        <p class="text-muted" id="detailsDescription">No description</p>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="detailsStatus" onchange="updateTaskStatus()">
                                <option value="To Do">To Do</option>
                                <option value="In Progress">In Progress</option>
                                <option value="Done">Done</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Assignee</label>
                            <select class="form-select" id="detailsAssignee" onchange="updateTaskAssignee()">
                                <option value="">Unassigned</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <h6>Task Details</h6>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <small>
                                        <div id="detailsMeta"></div>
                                    </small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Priority</h6>
                            <div id="priorityBadge"></div>
                        </div>
                    </div>
                    
                    <!-- Comments Section -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>Comments</h6>
                            <span class="badge bg-secondary" id="commentsCount">0</span>
                        </div>
                        <div id="commentsList" class="mb-3"></div>
                        <div class="input-group">
                            <textarea class="form-control" id="newComment" placeholder="Add a comment..." rows="2"></textarea>
                            <button class="btn btn-primary" onclick="addComment()">
                                <i class="bi bi-send"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Files Section -->
                    <div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6>Attachments</h6>

                            <span class="badge bg-secondary" id="filesCount">0</span>
                        </div>
                        <div id="filesList" class="mb-3"></div>
                        <div class="input-group">
                            <input type="file" class="form-control" id="fileUpload">
                            <button class="btn btn-outline-primary" onclick="uploadFile()">
                                <i class="bi bi-upload me-1"></i>Upload
                            </button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-danger" onclick="deleteCurrentTask()">
                        <i class="bi bi-trash me-1"></i>Delete Task
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Activity Modal -->
    <div class="modal fade" id="activityModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-activity me-2"></i>Recent Activity
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="activityList"></div>
                    <div class="empty-state" id="activityEmpty" style="display: none;">
                        <i class="bi bi-info-circle"></i>
                        <p>No activity yet</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS Bundle -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let currentProject = null;
        let currentTaskId = null;
        let users = [];
        let draggedTask = null;

        // Load current user
        async function loadCurrentUser() {
            const res = await fetch('/api/current-user');
            const user = await res.json();
            if (user.id) {
                document.getElementById('currentUser').innerHTML = `
                    <i class="bi bi-person-circle me-1"></i>
                    <span>${user.username}</span>
                `;
                checkProjectFromURL();
            } else {
                window.location.href = '/login';
            }
        }

        // Check for project ID in URL
        function checkProjectFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const projectId = urlParams.get('project');
            if (projectId) {
                loadProject(projectId);
            }
        }

        // Load project
        async function loadProject(projectId) {
            const res = await fetch(`/api/projects/${projectId}`);
            const project = await res.json();
            if (project) {
                currentProject = project;
                document.getElementById('projectName').textContent = project.name;
                document.getElementById('projectDescription').textContent = project.description || '';
                document.getElementById('kanbanContainer').classList.remove('d-none');
                document.getElementById('projectInfo').classList.add('d-none');
                loadUsersList();
                loadKanbanData();
            }
        }

        // Load users for assignment
        async function loadUsersList() {
            const res = await fetch('/api/users');
            users = await res.json();
            
            const assigneeSelect = document.getElementById('taskAssignee');
            const detailsAssignee = document.getElementById('detailsAssignee');
            
            assigneeSelect.innerHTML = '<option value="">Unassigned</option>';
            detailsAssignee.innerHTML = '<option value="">Unassigned</option>';
            
            users.forEach(user => {
                assigneeSelect.innerHTML += `<option value="${user.id}">${user.username}</option>`;
                detailsAssignee.innerHTML += `<option value="${user.id}">${user.username}</option>`;
            });
        }

        // Load kanban data
        async function loadKanbanData() {
            if (!currentProject) return;
            
            const res = await fetch(`/api/projects/${currentProject.id}/kanban`);
            const kanbanData = await res.json();
            
            renderColumn('todoTasks', kanbanData['To Do'], 'todo');
            renderColumn('inProgressTasks', kanbanData['In Progress'], 'inProgress');
            renderColumn('doneTasks', kanbanData['Done'], 'done');
            
            // Update counts
            document.getElementById('todoCount').textContent = kanbanData['To Do']?.length || 0;
            document.getElementById('inProgressCount').textContent = kanbanData['In Progress']?.length || 0;
            document.getElementById('doneCount').textContent = kanbanData['Done']?.length || 0;
            
            // Show/hide empty states
            toggleEmptyState('todo', kanbanData['To Do']?.length);
            toggleEmptyState('inProgress', kanbanData['In Progress']?.length);
            toggleEmptyState('done', kanbanData['Done']?.length);
        }

        // Toggle empty state
        function toggleEmptyState(column, count) {
            const emptyEl = document.getElementById(`${column}Empty`);
            if (emptyEl) {
                emptyEl.style.display = count > 0 ? 'none' : 'block';
            }
        }

        // Render tasks in a column
        function renderColumn(columnId, tasks, columnType) {
            const column = document.getElementById(columnId);
            column.innerHTML = '';
            
            if (tasks && tasks.length > 0) {
                tasks.forEach(task => {
                    column.appendChild(createTaskCard(task, columnType));
                });
            }
        }

        // Create task card element
        function createTaskCard(task, columnType) {
            const taskEl = document.createElement('div');
            taskEl.className = `task-card ${task.priority.toLowerCase()}`;
            taskEl.setAttribute('data-task-id', task.id);
            taskEl.setAttribute('draggable', 'true');
            taskEl.setAttribute('ondragstart', 'drag(event)');
            
            // Get assignee initials
            let assigneeInitials = '';
            if (task.assigned_username) {
                const nameParts = task.assigned_username.split(' ');
                assigneeInitials = nameParts.map(part => part[0]).join('').toUpperCase();
            }
            
            taskEl.innerHTML = `
                <div class="p-3">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0 task-title">${task.title}</h6>
                        <span class="task-priority priority-${task.priority.toLowerCase()}">
                            ${task.priority}
                        </span>
                    </div>
                    <p class="small text-muted mb-3 task-description">${task.description?.substring(0, 80) || ''}${task.description?.length > 80 ? '...' : ''}</p>
                    <div class="d-flex justify-content-between align-items-center">
                        ${assigneeInitials ? `
                            <div class="d-flex align-items-center">
                                <div class="assignee-avatar me-2" style="background-color: ${stringToColor(task.assigned_username)}">
                                    ${assigneeInitials}
                                </div>
                                <small class="text-muted">${task.assigned_username}</small>
                            </div>
                        ` : '<div></div>'}
                        <small class="text-muted">#${task.id}</small>
                    </div>
                </div>
            `;
            
            taskEl.onclick = (e) => {
                if (!e.target.closest('.task-priority')) {
                    showTaskDetails(task.id);
                }
            };
            
            return taskEl;
        }

        // Convert string to color for avatar
        function stringToColor(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                hash = str.charCodeAt(i) + ((hash << 5) - hash);
            }
            const colors = [
                '#0d6efd', '#6610f2', '#6f42c1', '#d63384', 
                '#dc3545', '#fd7e14', '#ffc107', '#198754',
                '#20c997', '#0dcaf0'
            ];
            return colors[Math.abs(hash) % colors.length];
        }

        // Task modals
        function showAddTaskModal() {
            document.getElementById('modalTitle').textContent = 'Add Task';
            document.getElementById('taskTitle').value = '';
            document.getElementById('taskDescription').value = '';
            const modal = new bootstrap.Modal(document.getElementById('taskModal'));
            modal.show();
        }

        async function saveTask() {
            const title = document.getElementById('taskTitle').value;
            const description = document.getElementById('taskDescription').value;
            const priority = document.getElementById('taskPriority').value;
            const assigned_to = document.getElementById('taskAssignee').value || null;
            
            if (!title.trim()) {
                alert('Title is required');
                return;
            }
            
            const res = await fetch(`/api/projects/${currentProject.id}/tasks`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, description, priority, assigned_to })
            });
            
            if (res.ok) {
                const modal = bootstrap.Modal.getInstance(document.getElementById('taskModal'));
                modal.hide();
                loadKanbanData();
            }
        }

        // Task details
        async function showTaskDetails(taskId) {
            currentTaskId = taskId;
            
            const tasksRes = await fetch(`/api/projects/${currentProject.id}/tasks`);
            const tasks = await tasksRes.json();
            const task = tasks.find(t => t.id == taskId);
            
            if (task) {
                document.getElementById('detailsTitle').textContent = task.title;
                document.getElementById('detailsDescription').textContent = task.description || 'No description';
                document.getElementById('detailsStatus').value = task.status;
                document.getElementById('detailsAssignee').value = task.assigned_to || '';
                
                document.getElementById('detailsMeta').innerHTML = `
                    Created by: <strong>${task.created_by_name}</strong><br>
                    Created: ${new Date(task.created_at).toLocaleDateString()}<br>
                    Last updated: ${new Date(task.updated_at).toLocaleDateString()}
                `;
                
                // Priority badge
                const priorityClass = `priority-${task.priority.toLowerCase()}`;
                document.getElementById('priorityBadge').innerHTML = `
                    <span class="task-priority ${priorityClass}">
                        ${task.priority} Priority
                    </span>
                `;
                
                loadComments(taskId);
                loadFiles(taskId);
                
                const modal = new bootstrap.Modal(document.getElementById('detailsModal'));
                modal.show();
            }
        }

        async function loadComments(taskId) {
            const res = await fetch(`/api/tasks/${taskId}/comments`);
            const comments = await res.json();
            
            const commentsList = document.getElementById('commentsList');
            commentsList.innerHTML = '';
            document.getElementById('commentsCount').textContent = comments.length;
            
            if (comments.length > 0) {
                comments.forEach(comment => {
                    const commentEl = document.createElement('div');
                    commentEl.className = 'comment-item';
                    commentEl.innerHTML = `
                        <div class="d-flex justify-content-between align-items-start mb-1">
                            <strong>${comment.username}</strong>
                            <small class="text-muted">
                                ${new Date(comment.created_at).toLocaleString()}
                            </small>
                        </div>
                        <p class="mb-0">${comment.content}</p>
                    `;
                    commentsList.appendChild(commentEl);
                });
            } else {
                commentsList.innerHTML = '<p class="text-muted text-center">No comments yet</p>';
            }
        }

        async function addComment() {
            const content = document.getElementById('newComment').value;
            if (!content.trim()) return;
            
            const res = await fetch(`/api/tasks/${currentTaskId}/comments`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ content })
            });
            
            if (res.ok) {
                document.getElementById('newComment').value = '';
                loadComments(currentTaskId);
            }
        }

        async function loadFiles(taskId) {
            const res = await fetch(`/api/tasks/${taskId}/files`);
            const files = await res.json();
            
            const filesList = document.getElementById('filesList');
            filesList.innerHTML = '';
            document.getElementById('filesCount').textContent = files.length;
            
            if (files.length > 0) {
                files.forEach(file => {
                    const fileEl = document.createElement('div');
                    fileEl.className = 'file-item';
                    fileEl.innerHTML = `
                        <div>
                            <i class="bi bi-file-earmark me-2"></i>
                           <a href="${file.cloudinary_url}" download class="text-decoration-none">
    ${file.filename}
</a>

                            <small class="text-muted d-block">Uploaded by ${file.username}</small>
                        </div>
                        <small class="text-muted">
                            ${new Date(file.uploaded_at).toLocaleDateString()}
                        </small>
                    `;
                    filesList.appendChild(fileEl);
                });
            } else {
                filesList.innerHTML = '<p class="text-muted text-center">No files attached</p>';
            }
        }

       async function uploadFile() {
    const fileInput = document.getElementById('fileUpload');

    if (!fileInput.files.length) {
        alert("Please select a file!");
        return;
    }

    const file = fileInput.files[0];

    // Allowed types: images + DOCX
    const allowedTypes = [
        'image/png',
        'image/jpeg',
        'image/jpg',
        'application/vnd.openxmlformats-officedocument.wordprocessingml.document' // DOCX
    ];

    if (!allowedTypes.includes(file.type)) {
        alert("Only DOCX and image files are allowed!");
        return;
    }

    const formData = new FormData();
    formData.append('file', file);

    try {
        const res = await fetch(`/api/tasks/${currentTaskId}/files`, {
            method: 'POST',
            body: formData
        });

        if (res.ok) {
            fileInput.value = '';
            loadFiles(currentTaskId);
            alert("File uploaded successfully!");
        } else {
            const data = await res.json();
            alert(data.error || "Upload failed!");
        }
    } catch (err) {
        alert("Something went wrong. Try again!");
    }
}


        async function updateTaskStatus() {
            const status = document.getElementById('detailsStatus').value;
            
            const tasksRes = await fetch(`/api/projects/${currentProject.id}/tasks`);
            const tasks = await tasksRes.json();
            const task = tasks.find(t => t.id == currentTaskId);
            
            if (task) {
                await fetch(`/api/tasks/${currentTaskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...task,
                        status: status
                    })
                });
                
                loadKanbanData();
            }
        }

        async function updateTaskAssignee() {
            const assigned_to = document.getElementById('detailsAssignee').value || null;
            
            const tasksRes = await fetch(`/api/projects/${currentProject.id}/tasks`);
            const tasks = await tasksRes.json();
            const task = tasks.find(t => t.id == currentTaskId);
            
            if (task) {
                await fetch(`/api/tasks/${currentTaskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...task,
                        assigned_to: assigned_to
                    })
                });
            }
        }

        async function deleteCurrentTask() {
            if (confirm('Are you sure you want to delete this task?')) {
                await fetch(`/api/tasks/${currentTaskId}`, {
                    method: 'DELETE'
                });
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('detailsModal'));
                modal.hide();
                loadKanbanData();
            }
        }

        // Activity modal
        async function showActivity() {
            const res = await fetch('/api/activity');
            const activities = await res.json();
            
            const activityList = document.getElementById('activityList');
            const activityEmpty = document.getElementById('activityEmpty');
            activityList.innerHTML = '';
            
            if (activities.length > 0) {
                activityEmpty.style.display = 'none';
                activities.forEach(activity => {
                    const activityEl = document.createElement('div');
                    activityEl.className = 'activity-item';
                    
                    // Determine icon based on action
                    let icon = 'bi-info-circle';
                    let color = 'text-primary';
                    if (activity.action.includes('created')) icon = 'bi-plus-circle';
                    if (activity.action.includes('updated')) icon = 'bi-pencil-square';
                    if (activity.action.includes('deleted')) icon = 'bi-trash';
                    if (activity.action.includes('uploaded')) icon = 'bi-upload';
                    
                    activityEl.innerHTML = `
                        <div class="d-flex">
                            <i class="bi ${icon} ${color} me-3 mt-1"></i>
                            <div>
                                <strong>${activity.username}</strong> ${activity.action} 
                                <span class="text-primary">${activity.entity_type}</span>
                                <div class="text-muted small mt-1">
                                    <i class="bi bi-clock me-1"></i>
                                    ${new Date(activity.created_at).toLocaleString()}
                                </div>
                            </div>
                        </div>
                    `;
                    activityList.appendChild(activityEl);
                });
            } else {
                activityList.innerHTML = '';
                activityEmpty.style.display = 'block';
            }
            
            const modal = new bootstrap.Modal(document.getElementById('activityModal'));
            modal.show();
        }

        // Drag and Drop
        function allowDrop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.add('drag-over');
        }

        function drag(ev) {
            draggedTask = ev.target.closest('.task-card');
            ev.dataTransfer.setData("text", ev.target.dataset.taskId);
            ev.dataTransfer.effectAllowed = "move";
        }

        function drop(ev) {
            ev.preventDefault();
            ev.currentTarget.classList.remove('drag-over');
            
            const taskId = ev.dataTransfer.getData("text");
            const targetColumn = ev.currentTarget.id;
            
            let newStatus = 'To Do';
            if (targetColumn === 'inProgressColumn') newStatus = 'In Progress';
            if (targetColumn === 'doneColumn') newStatus = 'Done';
            
            updateTaskStatusViaDrag(taskId, newStatus);
        }

        async function updateTaskStatusViaDrag(taskId, status) {
            const tasksRes = await fetch(`/api/projects/${currentProject.id}/tasks`);
            const tasks = await tasksRes.json();
            const task = tasks.find(t => t.id == taskId);
            
            if (task) {
                await fetch(`/api/tasks/${taskId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        ...task,
                        status: status
                    })
                });
                
                loadKanbanData();
            }
        }

        // Remove drag-over class when leaving
        document.querySelectorAll('.kanban-column-body').forEach(column => {
            column.addEventListener('dragleave', (e) => {
                e.currentTarget.classList.remove('drag-over');
            });
        });

        // Logout
        async function logout() {
            await fetch('/api/logout', { method: 'POST' });
            window.location.href = '/login';
        }

        // Initialize
        loadCurrentUser();
    </script>
</body>

</html>
